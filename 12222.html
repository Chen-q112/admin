<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>灾害小百科-如何避险</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f1b3a, #1c3a6d);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            position: relative;
        }
        
        /* 粒子背景效果 */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            animation: float 15s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-1000px) translateX(1000px) rotate(720deg); opacity: 0; }
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            padding: 20px;
            background: rgba(0, 15, 40, 0.7);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(66, 133, 244, 0.2);
            margin-top: 20px;
            animation: fadeIn 1s ease-out;
        }
        
        h1 {
            font-size: 3.2rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #ff7e5f, #feb47b, #ffcc00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            padding-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 4px;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            border-radius: 2px;
            box-shadow: 0 0 15px rgba(255, 126, 95, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto 30px;
            line-height: 1.6;
            color: #e0e0ff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        #gameContainer {
            background: rgba(0, 10, 30, 0.85);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            width: 800px;
            height: 600px;
            margin: 0 auto 30px;
            position: relative;
            border: 2px solid rgba(66, 133, 244, 0.3);
            transition: all 0.3s ease;
            animation: scaleIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        #gameContainer:hover {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            transform: translateY(-5px);
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-between;
            width: 800px;
            margin: 0 auto 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .stat-item i {
            color: #ff7e5f;
            font-size: 1.4rem;
            text-shadow: 0 0 10px rgba(255, 126, 95, 0.5);
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .btn {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            border: none;
            color: white;
            padding: 14px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(255, 126, 95, 0.4);
            position: relative;
            overflow: hidden;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20px;
            height: 200%;
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(25deg);
            transition: all 0.6s;
        }
        
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 126, 95, 0.6);
        }
        
        .btn:hover::after {
            left: 120%;
        }
        
        .btn:active {
            transform: translateY(1px) scale(0.98);
        }
        
        .btn.secondary {
            background: linear-gradient(to right, #4776E6, #8E54E9);
            box-shadow: 0 5px 15px rgba(71, 118, 230, 0.4);
        }
        
        .btn.secondary:hover {
            box-shadow: 0 8px 20px rgba(71, 118, 230, 0.6);
        }
        
        .btn.tertiary {
            background: linear-gradient(to right, #FF416C, #FF4B2B);
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
        }
        
        .btn.tertiary:hover {
            box-shadow: 0 8px 20px rgba(255, 65, 108, 0.6);
        }
        
        .knowledge-cards {
            display: flex;
            gap: 25px;
            margin-top: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            width: 350px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.4s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
        }
        
        .card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }
        
        .card h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #ff7e5f;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }
        
        .card h3 i {
            font-size: 1.8rem;
            text-shadow: 0 0 10px rgba(255, 126, 95, 0.5);
        }
        
        .card ul {
            padding-left: 20px;
            margin-top: 15px;
        }
        
        .card li {
            margin-bottom: 10px;
            line-height: 1.5;
            position: relative;
            padding-left: 10px;
        }
        
        .card li::before {
            content: '•';
            color: #ff7e5f;
            font-weight: bold;
            position: absolute;
            left: -15px;
            top: 0;
            font-size: 1.2rem;
        }
        
        .card .tip {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 3px solid #ff7e5f;
            position: relative;
            overflow: hidden;
        }
        
        .card .tip::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(to bottom, #ff7e5f, #feb47b);
        }
        
        .card .tip i {
            color: #ffcc00;
            margin-right: 5px;
        }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.7;
            padding: 20px;
            color: #a0b0ff;
            width: 100%;
        }
        
        /* 游戏内弹窗样式 */
        .popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: linear-gradient(145deg, rgba(0, 20, 40, 0.95), rgba(10, 30, 60, 0.95));
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 126, 95, 0.3);
            display: none;
            animation: popupIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            backdrop-filter: blur(10px);
        }
        
        @keyframes popupIn {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        .popup h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #ff7e5f;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .popup p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.6;
            color: #e0e0ff;
        }
        
        .popup .score {
            font-size: 3rem;
            font-weight: bold;
            color: #feb47b;
            margin: 20px 0;
            text-shadow: 0 0 15px rgba(254, 180, 123, 0.5);
        }
        
        .level-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* 响应式设计 */
        @media (max-width: 850px) {
            #gameContainer, .stats-bar {
                width: 95%;
                max-width: 600px;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .stats-bar {
                flex-wrap: wrap;
                gap: 15px;
                justify-content: center;
            }
            
            .knowledge-cards {
                gap: 15px;
            }
            
            .card {
                width: 100%;
            }
        }
        
        @media (max-width: 600px) {
            .controls {
                flex-direction: column;
                width: 90%;
            }
            
            .level-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
        }
        
        /* 波浪动画效果 */
        .wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1200 120" xmlns="http://www.w3.org/2000/svg"><path d="M0 0v46.29c47.79 22.2 103.59 32.17 158 28 70.36-5.37 136.33-33.31 206.8-37.5 73.84-4.36 147.54 16.88 218.2 35.26 69.27 18 138.3 24.88 209.4 13.08 36.15-6 69.85-17.84 104.45-29.34C989.49 25 1113-14.29 1200 52.47V0z" fill="rgba(255,255,255,0.07)"/></svg>');
            background-size: 1200px 100px;
            animation: wave 12s linear infinite;
        }
        
        .wave:nth-child(2) {
            animation-delay: -5s;
            opacity: 0.5;
        }
        
        .wave:nth-child(3) {
            animation-delay: -2s;
            opacity: 0.3;
        }
        
        @keyframes wave {
            0% { background-position-x: 0; }
            100% { background-position-x: 1200px; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* 分数动画 */
        @keyframes scorePop {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(1.3); opacity: 0; }
        }
        
        .score-pop {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffcc00;
            animation: scorePop 1s forwards;
            pointer-events: none;
            z-index: 100;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.8);
        }
        
        /* 新增按钮样式 */
        .level-btn {
            position: absolute;
            cursor: pointer;
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.6), rgba(30, 40, 80, 0.6));
            border-radius: 15px;
            padding: 14px 30px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            z-index: 10;
            color: white;
            font-size: 1.1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 2s infinite;
        }
        
        .level-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 126, 95, 0.5); }
            70% { box-shadow: 0 0 0 15px rgba(255, 126, 95, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 126, 95, 0); }
        }
        
        .level-btn.earthquake {
            left: 230px;
            top: 280px;
            background: linear-gradient(45deg, #ff7e5f, #feb47b);
            color: white;
        }
        
        .level-btn.flood {
            left: 430px;
            top: 280px;
            background: linear-gradient(45deg, #4776E6, #8E54E9);
            color: white;
        }
        
        .level-btn.fire {
            left: 330px;
            top: 380px;
            background: linear-gradient(45deg, #FF416C, #FF4B2B);
            color: white;
        }
        
        /* 音频控制 */
        .audio-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }
        
        .audio-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .audio-btn:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }
        
        /* 游戏进度条 */
        .progress-container {
            width: 800px;
            margin: 20px auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .progress-title {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.2rem;
            color: #feb47b;
            font-weight: 600;
        }
        
        .progress-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(255, 126, 95, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -45%;
            width: 40%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            transform: skewX(-30deg);
            animation: progressGlow 2s infinite;
        }
        
        @keyframes progressGlow {
            0% { left: -45%; }
            100% { left: 125%; }
        }
        
        /* 火焰动画 */
        @keyframes fire {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        
        /* 烟雾效果 */
        .smoke {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            filter: blur(5px);
            animation: smokeRise 4s linear forwards;
        }
        
        @keyframes smokeRise {
            0% { transform: translateY(0) scale(1); opacity: 0.8; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- 粒子背景 -->
    <div class="particles" id="particles"></div>
    
    <div class="container">
        <header>
            <h1><i class="fas fa-shield-alt"></i>灾害小百科-如何避险</h1>
            <p class="subtitle">通过互动游戏学习灾害应对知识，提高应急生存能力。在模拟场景中做出正确决策，保护自己和他人的安全！</p>
        </header>
        
        <div class="stats-bar">
            <div class="stat-item">
                <i class="fas fa-clock"></i>
                <span>剩余时间: <span id="time">90</span>秒</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-star"></i>
                <span>当前得分: <span id="score">0</span>/<span id="max-score">300</span></span>
            </div>
            <div class="stat-item">
                <i class="fas fa-heart"></i>
                <span>生命值: <span id="lives">3</span></span>
            </div>
            <div class="stat-item">
                <i class="fas fa-layer-group"></i>
                <span>当前关卡: <span id="level">主菜单</span></span>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-title">游戏进度</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div id="gameContainer">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
            <div class="wave"></div>
            <div class="wave"></div>
            <div class="wave"></div>
            
            <!-- 关卡按钮 -->
            <div class="level-btn earthquake" id="earthquakeBtn">
                <i class="fas fa-house-damage"></i>地震应急
            </div>
            <div class="level-btn flood" id="floodBtn">
                <i class="fas fa-water"></i>洪水逃生
            </div>
            <div class="level-btn fire" id="fireBtn">
                <i class="fas fa-fire"></i>火灾逃生
            </div>
            
            <!-- 音频控制 -->
            <div class="audio-controls">
                <div class="audio-btn" id="musicBtn"><i class="fas fa-music"></i></div>
                <div class="audio-btn" id="soundBtn"><i class="fas fa-volume-up"></i></div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" id="startBtn"><i class="fas fa-play"></i>开始游戏</button>
            <button class="btn secondary" id="menuBtn"><i class="fas fa-home"></i>返回主菜单</button>
            <button class="btn tertiary" id="resetBtn"><i class="fas fa-redo"></i>重置进度</button>
        </div>
        
        <div class="knowledge-cards">
            <div class="card">
                <h3><i class="fas fa-house-damage"></i> 地震应对要点</h3>
                <p>地震发生时保持冷静，采取正确行动可大幅提高生存几率：</p>
                <ul>
                    <li>立即寻找坚固的桌子或家具下方躲避</li>
                    <li>保护头部和颈部，使用手臂或枕头遮挡</li>
                    <li>远离窗户、玻璃和可能坠落的物品</li>
                    <li>不要使用电梯，地震停止后走楼梯撤离</li>
                    <li>准备应急包：水、食物、急救用品、手电筒等</li>
                </ul>
                <div class="tip">
                    <i class="fas fa-lightbulb"></i> 游戏提示：在地震应急关卡中，请将正确的应急物品拖入应急包，避免拖入非必需品。
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-water"></i> 洪水自救指南</h3>
                <p>洪水来袭时，时间就是生命，掌握这些自救知识：</p>
                <ul>
                    <li>立即向高处转移，避免在低洼处停留</li>
                    <li>不要步行或驾车通过积水区域</li>
                    <li>准备漂浮物如救生衣、充气玩具等</li>
                    <li>远离电线杆和电力设施，防止触电</li>
                    <li>穿着鲜艳衣物便于救援人员发现</li>
                    <li>准备应急雨具：雨衣、雨鞋、防水背包</li>
                </ul>
                <div class="tip">
                    <i class="fas fa-lightbulb"></i> 游戏提示：在洪水逃生关卡中，使用左右方向键移动角色收集雨具（达到300分通关），避开闪电。
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-fire"></i> 火灾逃生技巧</h3>
                <p>火灾发生时保持冷静，迅速采取正确逃生措施：</p>
                <ul>
                    <li>立即趴低身体，用湿毛巾捂住口鼻</li>
                    <li>测试门温，如门烫手切勿开门</li>
                    <li>选择安全通道撤离，勿使用电梯</li>
                    <li>如被困，用湿布封堵门缝，在窗口发出求救信号</li>
                    <li>身上着火时，应就地打滚压灭火苗</li>
                    <li>准备防火毯、灭火器等应急物品</li>
                </ul>
                <div class="tip">
                    <i class="fas fa-lightbulb"></i> 游戏提示：在火灾逃生关卡中，使用方向键移动角色收集防火物品并到达出口，避开火焰。
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>© 2025 灾害小百科-如何避险 | 安全教育游戏 | 提高灾害应对能力</p>
        </div>
    </div>
    
    <div class="popup" id="resultPopup">
        <h2 id="resultTitle">关卡完成!</h2>
        <p id="resultMessage">你成功应对了灾害场景，表现很棒！</p>
        <div class="score">得分: <span id="finalScore">0</span></div>
        <div class="level-buttons">
            <button class="btn" id="nextBtn"><i class="fas fa-arrow-right"></i>下一关卡</button>
            <button class="btn secondary" id="retryBtn"><i class="fas fa-redo"></i>重新挑战</button>
            <button class="btn secondary" id="menuBtn2"><i class="fas fa-home"></i>返回主菜单</button>
        </div>
    </div>

    <script>
        // 游戏基础配置
        const GAME_CONFIG = {
            width: 800,
            height: 600,
            maxTime: 90,
            correctScore: 30,
            wrongPenalty: 5,
            lives: 3,
            floodWinScore: 300, // 洪水关卡获胜分数
            fireWinScore: 250   // 火灾关卡获胜分数
        };

        // 游戏状态
        let gameState = {
            score: 0,
            timeLeft: GAME_CONFIG.maxTime,
            lives: GAME_CONFIG.lives,
            currentLevel: 'menu',
            gameRunning: false,
            timer: null,
            levelsCompleted: {
                earthquake: false,
                flood: false,
                fire: false
            },
            audioEnabled: {
                music: true,
                sound: true
            }
        };

        // 获取Canvas上下文
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // 游戏资源
        const gameAssets = {
            // 使用Canvas绘制代替外部图片
            drawMenuBg() {
                const gradient = ctx.createLinearGradient(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                gradient.addColorStop(0, '#1a2980');
                gradient.addColorStop(1, '#26d0ce');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                
                // 绘制装饰圆圈
                ctx.fillStyle = 'rgba(38, 208, 206, 0.5)';
                ctx.beginPath();
                ctx.arc(200, 200, 80, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(600, 300, 100, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(400, 400, 120, 0, Math.PI * 2);
                ctx.fill();
            },
            
            drawEarthquakeBg() {
                ctx.fillStyle = '#4c5f7d';
                ctx.fillRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                
                // 建筑物
                ctx.fillStyle = '#dab48a';
                ctx.fillRect(200, 300, 100, 100);
                
                ctx.fillStyle = '#e5c6c3';
                ctx.fillRect(400, 200, 200, 200);
                
                ctx.fillStyle = '#d4b68a';
                ctx.fillRect(500, 350, 150, 100);
                
                // 震动效果
                if (game.gameRunning && gameState.currentLevel === 'earthquake') {
                    const offsetX = Math.sin(Date.now() / 100) * 3;
                    const offsetY = Math.cos(Date.now() / 120) * 3;
                    ctx.translate(offsetX, offsetY);
                }
            },
            
            drawFloodBg() {
                const gradient = ctx.createLinearGradient(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                gradient.addColorStop(0, '#3572a8');
                gradient.addColorStop(1, '#4776e6');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                
                // 洪水区域
                ctx.fillStyle = '#8e54e9';
                ctx.globalAlpha = 0.6;
                ctx.fillRect(0, 450, GAME_CONFIG.width, 150);
                ctx.globalAlpha = 1.0;
                
                // 雨滴效果
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                for (let i = 0; i < 100; i++) {
                    const x = Math.random() * GAME_CONFIG.width;
                    const y = Math.random() * GAME_CONFIG.height;
                    ctx.beginPath();
                    ctx.arc(x, y, 1, 0, Math.PI * 2);
                    ctx.fill();
                }
            },
            
            drawFireBg() {
                // 创建火焰背景
                const gradient = ctx.createLinearGradient(0, 0, 0, GAME_CONFIG.height);
                gradient.addColorStop(0, '#ff9966');
                gradient.addColorStop(0.5, '#ff5e62');
                gradient.addColorStop(1, '#000');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                
                // 烟雾效果
                if (Math.random() < 0.1) {
                    const smoke = document.createElement('div');
                    smoke.className = 'smoke';
                    smoke.style.left = Math.random() * GAME_CONFIG.width + 'px';
                    smoke.style.top = GAME_CONFIG.height + 'px';
                    document.getElementById('gameContainer').appendChild(smoke);
                    setTimeout(() => smoke.remove(), 4000);
                }
            },
            
            drawWater(x, y) {
                ctx.fillStyle = '#35a4ff';
                ctx.beginPath();
                ctx.arc(x + 30, y + 30, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // 水滴效果
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.beginPath();
                ctx.arc(x + 20, y + 20, 5, 0, Math.PI * 2);
                ctx.fill();
            },
            
            drawFood(x, y) {
                ctx.fillStyle = '#f2c443';
                ctx.beginPath();
                ctx.roundRect(x + 10, y + 10, 40, 40, 5);
                ctx.fill();
                
                // 细节
                ctx.fillStyle = '#e6b33d';
                ctx.fillRect(x + 15, y + 15, 30, 10);
            },
            
            drawMedicine(x, y) {
                ctx.fillStyle = '#f55f5e';
                ctx.beginPath();
                ctx.roundRect(x + 15, y + 5, 30, 50, 3);
                ctx.fill();
                
                ctx.fillStyle = '#fff';
                ctx.fillRect(x + 25, y + 15, 10, 30);
                
                // 红十字
                ctx.fillStyle = '#fff';
                ctx.fillRect(x + 20, y + 25, 20, 4);
                ctx.fillRect(x + 25, y + 20, 4, 20);
            },
            
            drawFlashlight(x, y) {
                ctx.fillStyle = '#888';
                ctx.beginPath();
                ctx.roundRect(x + 22.5, y + 10, 15, 40, 3);
                ctx.fill();
                
                ctx.fillStyle = '#ffff00';
                ctx.beginPath();
                ctx.arc(x + 30, y + 30, 15, 0.25 * Math.PI, 0.75 * Math.PI);
                ctx.lineTo(x + 15, y + 15);
                ctx.closePath();
                ctx.fill();
            },
            
            drawRadio(x, y) {
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.arc(x + 30, y + 30, 20, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.roundRect(x + 20, y + 20, 20, 10, 2);
                ctx.fill();
                
                // 按钮
                ctx.fillStyle = '#ff7e5f';
                ctx.beginPath();
                ctx.arc(x + 20, y + 25, 3, 0, Math.PI * 2);
                ctx.fill();
            },
            
            drawToy(x, y) {
                ctx.fillStyle = '#ff00cc';
                ctx.beginPath();
                ctx.arc(x + 30, y + 30, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // 笑脸
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(x + 30, y + 35, 8, 0, Math.PI, false);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.arc(x + 25, y + 25, 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(x + 35, y + 25, 3, 0, Math.PI * 2);
                ctx.fill();
            },
            
            drawPlayer(x, y) {
                // 头部
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(x + 30, y + 20, 10, 0, Math.PI * 2);
                ctx.fill();
                
                // 身体
                ctx.fillStyle = '#00a0ff';
                ctx.beginPath();
                ctx.roundRect(x + 20, y + 30, 20, 30, 5);
                ctx.fill();
                
                // 腿部
                ctx.fillStyle = '#1e5f9c';
                ctx.fillRect(x + 20, y + 60, 8, 20);
                ctx.fillRect(x + 32, y + 60, 8, 20);
                
                // 手臂
                ctx.fillStyle = '#1e5f9c';
                ctx.fillRect(x + 10, y + 30, 8, 20);
                ctx.fillRect(x + 42, y + 30, 8, 20);
            },
            
            drawUmbrella(x, y) {
                ctx.fillStyle = '#337abe';
                ctx.beginPath();
                ctx.moveTo(x + 30, y + 10);
                ctx.bezierCurveTo(
                    x + 10, y + 15,
                    x + 10, y + 35,
                    x + 30, y + 30
                );
                ctx.bezierCurveTo(
                    x + 50, y + 35,
                    x + 50, y + 15,
                    x + 30, y + 10
                );
                ctx.fill();
                
                // 手柄
                ctx.fillStyle = '#75543e';
                ctx.fillRect(x + 28, y + 30, 4, 20);
                
                // 伞尖
                ctx.fillStyle = '#ffcc00';
                ctx.beginPath();
                ctx.arc(x + 30, y + 10, 3, 0, Math.PI * 2);
                ctx.fill();
            },
            
            drawLifebuoy(x, y) {
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(x + 30, y + 30, 20, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(x + 30, y + 30, 10, 0, Math.PI * 2);
                ctx.fill();
                
                // 细节
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x + 30, y + 30, 15, 0, Math.PI * 2);
                ctx.stroke();
            },
            
            drawLightning(x, y) {
                ctx.fillStyle = '#ffff00';
                ctx.beginPath();
                ctx.moveTo(x + 30, y + 5);
                ctx.lineTo(x + 40, y + 35);
                ctx.lineTo(x + 25, y + 35);
                ctx.lineTo(x + 35, y + 55);
                ctx.lineTo(x + 20, y + 25);
                ctx.lineTo(x + 35, y + 25);
                ctx.closePath();
                ctx.fill();
                
                // 光晕
                ctx.fillStyle = 'rgba(255, 255, 0, 0.3)';
                ctx.beginPath();
                ctx.arc(x + 30, y + 30, 25, 0, Math.PI * 2);
                ctx.fill();
            },
            
            drawTowel(x, y) {
                ctx.fillStyle = '#35d0ba';
                ctx.beginPath();
                ctx.roundRect(x + 10, y + 15, 40, 30, 5);
                ctx.fill();
                
                // 条纹
                ctx.fillStyle = '#fff';
                for (let i = 0; i < 4; i++) {
                    ctx.fillRect(x + 10, y + 15 + i * 7.5, 40, 2);
                }
            },
            
            drawFireBlanket(x, y) {
                ctx.fillStyle = '#f55f5e';
                ctx.beginPath();
                ctx.roundRect(x + 10, y + 10, 40, 40, 5);
                ctx.fill();
                
                // 十字
                ctx.fillStyle = '#fff';
                ctx.fillRect(x + 20, y + 15, 20, 3);
                ctx.fillRect(x + 15, y + 20, 3, 20);
            },
            
            drawExitSign(x, y) {
                ctx.fillStyle = '#00cc44';
                ctx.beginPath();
                ctx.roundRect(x + 15, y + 15, 30, 30, 5);
                ctx.fill();
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('出口', x + 30, y + 30);
            },
            
            drawFlame(x, y) {
                // 火焰效果
                const gradient = ctx.createRadialGradient(
                    x + 30, y + 30, 5,
                    x + 30, y + 30, 20
                );
                gradient.addColorStop(0, '#ffcc00');
                gradient.addColorStop(0.5, '#ff6600');
                gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(x + 30, y + 30, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // 火焰形状
                ctx.fillStyle = '#ff3300';
                ctx.beginPath();
                ctx.moveTo(x + 15, y + 50);
                ctx.lineTo(x + 30, y + 10);
                ctx.lineTo(x + 45, y + 50);
                ctx.closePath();
                ctx.fill();
            }
        };

        // DOM元素
        const timeElement = document.getElementById('time');
        const scoreElement = document.getElementById('score');
        const maxScoreElement = document.getElementById('max-score');
        const livesElement = document.getElementById('lives');
        const levelElement = document.getElementById('level');
        const progressFill = document.getElementById('progressFill');
        const startBtn = document.getElementById('startBtn');
        const menuBtn = document.getElementById('menuBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultPopup = document.getElementById('resultPopup');
        const resultTitle = document.getElementById('resultTitle');
        const resultMessage = document.getElementById('resultMessage');
        const finalScore = document.getElementById('finalScore');
        const nextBtn = document.getElementById('nextBtn');
        const retryBtn = document.getElementById('retryBtn');
        const menuBtn2 = document.getElementById('menuBtn2');
        const earthquakeBtn = document.getElementById('earthquakeBtn');
        const floodBtn = document.getElementById('floodBtn');
        const fireBtn = document.getElementById('fireBtn');
        const musicBtn = document.getElementById('musicBtn');
        const soundBtn = document.getElementById('soundBtn');

        // 游戏对象
        const game = {
            init() {
                this.setupEventListeners();
                this.loadGameState();
                this.createMainMenu();
                this.updateUI();
                this.lastFrameTime = 0;
                this.createParticles();
                this.gameLoop();
            },
            
            createParticles() {
                const particlesContainer = document.getElementById('particles');
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    
                    // 随机属性
                    const size = Math.random() * 10 + 2;
                    const posX = Math.random() * 100;
                    const posY = Math.random() * 100;
                    const duration = Math.random() * 20 + 10;
                    const delay = Math.random() * 5;
                    
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.left = `${posX}%`;
                    particle.style.top = `${posY}%`;
                    particle.style.animationDuration = `${duration}s`;
                    particle.style.animationDelay = `${delay}s`;
                    
                    particlesContainer.appendChild(particle);
                }
            },
            
            setupEventListeners() {
                startBtn.addEventListener('click', () => {
                    if (gameState.currentLevel === 'menu') {
                        this.createEarthquakeScene();
                    } else if (!gameState.gameRunning) {
                        this.startLevel();
                    }
                });
                
                menuBtn.addEventListener('click', () => this.createMainMenu());
                resetBtn.addEventListener('click', () => this.resetGame());
                nextBtn.addEventListener('click', () => this.nextLevel());
                retryBtn.addEventListener('click', () => {
                    if (gameState.currentLevel === 'earthquake') {
                        this.createEarthquakeScene();
                    } else if (gameState.currentLevel === 'flood') {
                        this.createFloodScene();
                    } else {
                        this.createFireScene();
                    }
                });
                menuBtn2.addEventListener('click', () => this.createMainMenu());
                
                // 添加键盘事件监听
                document.addEventListener('keydown', (e) => {
                    if (!gameState.gameRunning) return;
                    
                    if (gameState.currentLevel === 'flood') {
                        if (e.key === 'ArrowLeft') {
                            this.playerX = Math.max(50, this.playerX - 25);
                        } else if (e.key === 'ArrowRight') {
                            this.playerX = Math.min(GAME_CONFIG.width - 80, this.playerX + 25);
                        }
                    } else if (gameState.currentLevel === 'fire') {
                        if (e.key === 'ArrowLeft') {
                            this.playerX = Math.max(50, this.playerX - 15);
                        } else if (e.key === 'ArrowRight') {
                            this.playerX = Math.min(GAME_CONFIG.width - 80, this.playerX + 15);
                        } else if (e.key === 'ArrowUp') {
                            this.playerY = Math.max(100, this.playerY - 15);
                        } else if (e.key === 'ArrowDown') {
                            this.playerY = Math.min(GAME_CONFIG.height - 100, this.playerY + 15);
                        }
                    }
                });
                
                // 添加鼠标事件监听
                canvas.addEventListener('mousedown', (e) => {
                    if (gameState.currentLevel === 'earthquake' && gameState.gameRunning) {
                        this.handleMouseDown(e);
                    }
                });
                
                canvas.addEventListener('mousemove', (e) => {
                    if (gameState.currentLevel === 'earthquake' && gameState.gameRunning && this.draggingItem) {
                        this.handleMouseMove(e);
                    }
                });
                
                canvas.addEventListener('mouseup', () => {
                    if (gameState.currentLevel === 'earthquake' && gameState.gameRunning && this.draggingItem) {
                        this.handleMouseUp();
                    }
                });
                
                // 添加关卡按钮点击事件
                earthquakeBtn.addEventListener('click', () => this.createEarthquakeScene());
                floodBtn.addEventListener('click', () => this.createFloodScene());
                fireBtn.addEventListener('click', () => this.createFireScene());
                
                // 音频控制
                musicBtn.addEventListener('click', () => this.toggleAudio('music'));
                soundBtn.addEventListener('click', () => this.toggleAudio('sound'));
            },
            
            toggleAudio(type) {
                gameState.audioEnabled[type] = !gameState.audioEnabled[type];
                const icon = gameState.audioEnabled[type] ? 
                    (type === 'music' ? 'fa-music' : 'fa-volume-up') : 
                    (type === 'music' ? 'fa-music' : 'fa-volume-mute');
                
                document.getElementById(`${type}Btn`).innerHTML = `<i class="fas ${icon}"></i>`;
                
                // 保存音频设置
                this.saveGameState();
            },
            
            updateUI() {
                timeElement.textContent = gameState.timeLeft;
                scoreElement.textContent = gameState.score;
                
                if (gameState.currentLevel === 'flood') {
                    maxScoreElement.textContent = GAME_CONFIG.floodWinScore;
                } else if (gameState.currentLevel === 'fire') {
                    maxScoreElement.textContent = GAME_CONFIG.fireWinScore;
                } else {
                    maxScoreElement.textContent = '—';
                }
                
                livesElement.textContent = gameState.lives;
                levelElement.textContent = {
                    'menu': '主菜单',
                    'earthquake': '地震应急',
                    'flood': '洪水逃生',
                    'fire': '火灾逃生'
                }[gameState.currentLevel];
                
                // 更新进度条
                const totalLevels = 3;
                const completedLevels = Object.values(gameState.levelsCompleted).filter(Boolean).length;
                const progress = (completedLevels / totalLevels) * 100;
                progressFill.style.width = `${progress}%`;
                
                // 显示/隐藏关卡按钮
                if (gameState.currentLevel === 'menu') {
                    earthquakeBtn.style.display = 'block';
                    floodBtn.style.display = 'block';
                    fireBtn.style.display = 'block';
                } else {
                    earthquakeBtn.style.display = 'none';
                    floodBtn.style.display = 'none';
                    fireBtn.style.display = 'none';
                }
            },
            
            startLevel() {
                gameState.gameRunning = true;
                gameState.timeLeft = GAME_CONFIG.maxTime;
                
                // 清除之前的计时器
                if (gameState.timer) {
                    clearInterval(gameState.timer);
                    gameState.timer = null;
                }
                
                // 启动新计时器
                gameState.timer = setInterval(() => {
                    if (gameState.gameRunning) {
                        gameState.timeLeft--;
                        this.updateUI();
                        
                        if (gameState.timeLeft <= 0) {
                            this.endGame(false, "时间耗尽!");
                        }
                    }
                }, 1000);
                
                this.updateUI();
            },
            
            stopTimer() {
                if (gameState.timer) {
                    clearInterval(gameState.timer);
                    gameState.timer = null;
                }
            },
            
            endGame(success, message) {
                this.stopTimer();
                gameState.gameRunning = false;
                
                if (success) {
                    gameState.levelsCompleted[gameState.currentLevel] = true;
                    this.saveGameState();
                }
                
                // 显示结果弹窗
                resultTitle.textContent = success ? "任务成功!" : "任务失败";
                resultMessage.textContent = message;
                finalScore.textContent = gameState.score;
                resultPopup.style.display = "block";
                
                // 隐藏下一关按钮如果不是成功
                nextBtn.style.display = success ? "inline-block" : "none";
            },
            
            createMainMenu() {
                this.stopTimer();
                gameState.currentLevel = 'menu';
                gameState.score = 0;
                gameState.lives = GAME_CONFIG.lives;
                gameState.timeLeft = GAME_CONFIG.maxTime;
                resultPopup.style.display = "none";
                this.updateUI();
            },
            
            nextLevel() {
                if (gameState.currentLevel === 'earthquake') {
                    this.createFloodScene();
                } else if (gameState.currentLevel === 'flood') {
                    this.createFireScene();
                } else {
                    this.createMainMenu();
                }
            },
            
            resetGame() {
                gameState.levelsCompleted = {
                    earthquake: false,
                    flood: false,
                    fire: false
                };
                localStorage.removeItem('disasterGameState');
                this.updateUI();
            },
            
            saveGameState() {
                localStorage.setItem('disasterGameState', JSON.stringify({
                    levelsCompleted: gameState.levelsCompleted,
                    audioEnabled: gameState.audioEnabled
                }));
            },
            
            loadGameState() {
                const savedState = localStorage.getItem('disasterGameState');
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                    gameState.levelsCompleted = parsed.levelsCompleted || gameState.levelsCompleted;
                    gameState.audioEnabled = parsed.audioEnabled || gameState.audioEnabled;
                    
                    // 更新音频按钮图标
                    musicBtn.innerHTML = `<i class="fas ${gameState.audioEnabled.music ? 'fa-music' : 'fa-music'}"></i>`;
                    soundBtn.innerHTML = `<i class="fas ${gameState.audioEnabled.sound ? 'fa-volume-up' : 'fa-volume-mute'}"></i>`;
                }
            },
            
            createEarthquakeScene() {
                gameState.currentLevel = 'earthquake';
                gameState.score = 0;
                gameState.lives = GAME_CONFIG.lives;
                resultPopup.style.display = "none";
                
                // 初始化地震场景物品
                this.earthquakeItems = [
                    { type: 'water', x: 80, y: 200, width: 60, height: 60, correct: true, collected: false },
                    { type: 'food', x: 80, y: 300, width: 60, height: 60, correct: true, collected: false },
                    { type: 'medicine', x: 80, y: 400, width: 60, height: 60, correct: true, collected: false },
                    { type: 'flashlight', x: 200, y: 200, width: 60, height: 60, correct: true, collected: false },
                    { type: 'radio', x: 200, y: 300, width: 60, height: 60, correct: true, collected: false },
                    { type: 'toy', x: 200, y: 400, width: 60, height: 60, correct: false, collected: false }
                ];
                
                this.draggingItem = null;
                this.dragOffsetX = 0;
                this.dragOffsetY = 0;
                
                this.correctItemsCount = 0;
                this.totalCorrectItems = this.earthquakeItems.filter(item => item.correct).length;
                
                this.updateUI();
                this.startLevel();
            },
            
            createFloodScene() {
                gameState.currentLevel = 'flood';
                gameState.score = 0;
                gameState.lives = GAME_CONFIG.lives;
                resultPopup.style.display = "none";
                
                // 初始化洪水场景
                this.playerX = GAME_CONFIG.width / 2 - 40;
                this.playerY = GAME_CONFIG.height - 100;
                this.floodItems = [];
                this.lastItemTime = 0;
                this.itemGenerationInterval = 2200; // 降低物品掉落频率
                this.scorePopups = [];
                
                this.updateUI();
                this.startLevel();
            },
            
            createFireScene() {
                gameState.currentLevel = 'fire';
                gameState.score = 0;
                gameState.lives = GAME_CONFIG.lives;
                resultPopup.style.display = "none";
                
                // 初始化火灾场景
                this.playerX = GAME_CONFIG.width / 2 - 40;
                this.playerY = GAME_CONFIG.height - 100;
                this.fireItems = [];
                this.flames = [];
                this.lastItemTime = 0;
                this.lastFlameTime = 0;
                this.itemGenerationInterval = 2500;
                this.flameGenerationInterval = 1500;
                this.scorePopups = [];
                
                // 创建出口
                this.exit = {
                    x: GAME_CONFIG.width - 100,
                    y: 80,
                    width: 60,
                    height: 60
                };
                
                this.updateUI();
                this.startLevel();
            },
            
            handleMouseDown(e) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // 检查是否点击了物品
                for (let i = 0; i < this.earthquakeItems.length; i++) {
                    const item = this.earthquakeItems[i];
                    if (!item.collected && 
                        mouseX > item.x && mouseX < item.x + item.width &&
                        mouseY > item.y && mouseY < item.y + item.height) {
                        
                        this.draggingItem = item;
                        this.dragOffsetX = mouseX - item.x;
                        this.dragOffsetY = mouseY - item.y;
                        break;
                    }
                }
            },
            
            handleMouseMove(e) {
                if (!this.draggingItem) return;
                
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                this.draggingItem.x = mouseX - this.dragOffsetX;
                this.draggingItem.y = mouseY - this.dragOffsetY;
            },
            
            handleMouseUp() {
                if (!this.draggingItem) return;
                
                const item = this.draggingItem;
                const backpackArea = {x: 500, y: 150, width: 250, height: 300};
                
                // 检查是否在应急包区域内
                if (item.x > backpackArea.x && item.x + item.width < backpackArea.x + backpackArea.width &&
                    item.y > backpackArea.y && item.y + item.height < backpackArea.y + backpackArea.height) {
                    
                    // 物品放入应急包
                    item.collected = true;
                    
                    if (item.correct) {
                        // 正确物品
                        gameState.score += GAME_CONFIG.correctScore;
                        this.correctItemsCount++;
                        
                        // 检查是否收集所有正确物品
                        if (this.correctItemsCount >= this.totalCorrectItems) {
                            this.endGame(true, "你收集了所有应急物品!");
                        }
                    } else {
                        // 错误物品
                        gameState.timeLeft -= GAME_CONFIG.wrongPenalty;
                        if (gameState.timeLeft < 0) gameState.timeLeft = 0;
                        
                        // 重置位置
                        if (item.type === 'toy') {
                            item.x = 200;
                            item.y = 400;
                        }
                    }
                } else {
                    // 不在应急包区域内，重置位置
                    if (item.type === 'water') {
                        item.x = 80;
                        item.y = 200;
                    } else if (item.type === 'food') {
                        item.x = 80;
                        item.y = 300;
                    } else if (item.type === 'medicine') {
                        item.x = 80;
                        item.y = 400;
                    } else if (item.type === 'flashlight') {
                        item.x = 200;
                        item.y = 200;
                    } else if (item.type === 'radio') {
                        item.x = 200;
                        item.y = 300;
                    } else if (item.type === 'toy') {
                        item.x = 200;
                        item.y = 400;
                    }
                }
                
                this.draggingItem = null;
                this.updateUI();
            },
            
            generateFloodItems() {
                const now = Date.now();
                if (now - this.lastItemTime > this.itemGenerationInterval) { 
                    this.lastItemTime = now;
                    
                    // 控制物品生成概率
                    const rand = Math.random();
                    const type = rand < 0.6 ? (Math.random() > 0.5 ? 'umbrella' : 'lifebuoy') : 'lightning';
                    const x = Math.random() * (GAME_CONFIG.width - 60);
                    
                    this.floodItems.push({
                        type: type,
                        x: x,
                        y: -60,
                        width: 60,
                        height: 60,
                        speed: 1.5 + Math.random() * 1.5 // 降低掉落速度
                    });
                }
            },
            
            generateFireItems() {
                const now = Date.now();
                if (now - this.lastItemTime > this.itemGenerationInterval) { 
                    this.lastItemTime = now;
                    
                    // 控制物品生成概率
                    const rand = Math.random();
                    const type = rand < 0.7 ? (Math.random() > 0.5 ? 'towel' : 'fireBlanket') : 'exit';
                    const x = Math.random() * (GAME_CONFIG.width - 60);
                    
                    this.fireItems.push({
                        type: type,
                        x: x,
                        y: -60,
                        width: 60,
                        height: 60,
                        speed: 1.2 + Math.random() * 1.2
                    });
                }
                
                // 生成火焰
                if (now - this.lastFlameTime > this.flameGenerationInterval) {
                    this.lastFlameTime = now;
                    
                    this.flames.push({
                        x: Math.random() * (GAME_CONFIG.width - 60),
                        y: Math.random() * (GAME_CONFIG.height - 200) + 100,
                        width: 60,
                        height: 60
                    });
                }
            },
            
            updateFloodItems() {
                // 更新物品位置
                for (let i = this.floodItems.length - 1; i >= 0; i--) {
                    const item = this.floodItems[i];
                    item.y += item.speed;
                    
                    // 碰撞检测
                    const playerRect = {x: this.playerX, y: this.playerY, width: 60, height: 80};
                    const itemRect = {x: item.x, y: item.y, width: item.width, height: item.height};
                    
                    if (this.checkCollision(playerRect, itemRect)) {
                        if (item.type === 'lightning') {
                            gameState.lives--;
                            if (gameState.lives <= 0) {
                                gameState.lives = 0;
                                this.endGame(false, "生命值耗尽!");
                            }
                        } else {
                            gameState.score += GAME_CONFIG.correctScore;
                            // 添加分数弹出效果
                            this.scorePopups.push({
                                x: item.x,
                                y: item.y,
                                text: `+${GAME_CONFIG.correctScore}`,
                                startTime: Date.now()
                            });
                            
                            // 检查是否达到300分
                            if (gameState.score >= GAME_CONFIG.floodWinScore) {
                                this.endGame(true, "恭喜! 你成功收集了足够的雨具!");
                            }
                        }
                        this.floodItems.splice(i, 1);
                        this.updateUI();
                        continue;
                    }
                    
                    // 移除超出屏幕的物品
                    if (item.y > GAME_CONFIG.height) {
                        this.floodItems.splice(i, 1);
                    }
                }
                
                // 更新分数弹出效果
                for (let i = this.scorePopups.length - 1; i >= 0; i--) {
                    const popup = this.scorePopups[i];
                    const elapsed = Date.now() - popup.startTime;
                    
                    if (elapsed > 1000) {
                        this.scorePopups.splice(i, 1);
                    }
                }
            },
            
            updateFireScene() {
                // 更新物品位置
                for (let i = this.fireItems.length - 1; i >= 0; i--) {
                    const item = this.fireItems[i];
                    item.y += item.speed;
                    
                    // 碰撞检测
                    const playerRect = {x: this.playerX, y: this.playerY, width: 60, height: 80};
                    const itemRect = {x: item.x, y: item.y, width: item.width, height: item.height};
                    
                    if (this.checkCollision(playerRect, itemRect)) {
                        if (item.type === 'exit') {
                            // 到达出口
                            this.endGame(true, "恭喜! 你成功逃出了火灾现场!");
                        } else {
                            gameState.score += GAME_CONFIG.correctScore;
                            // 添加分数弹出效果
                            this.scorePopups.push({
                                x: item.x,
                                y: item.y,
                                text: `+${GAME_CONFIG.correctScore}`,
                                startTime: Date.now()
                            });
                            
                            // 检查是否达到250分
                            if (gameState.score >= GAME_CONFIG.fireWinScore) {
                                this.endGame(true, "恭喜! 你收集了足够的防火物品!");
                            }
                        }
                        this.fireItems.splice(i, 1);
                        this.updateUI();
                        continue;
                    }
                    
                    // 移除超出屏幕的物品
                    if (item.y > GAME_CONFIG.height) {
                        this.fireItems.splice(i, 1);
                    }
                }
                
                // 火焰碰撞检测
                for (let i = this.flames.length - 1; i >= 0; i--) {
                    const flame = this.flames[i];
                    const playerRect = {x: this.playerX, y: this.playerY, width: 60, height: 80};
                    const flameRect = {x: flame.x, y: flame.y, width: flame.width, height: flame.height};
                    
                    if (this.checkCollision(playerRect, flameRect)) {
                        gameState.lives--;
                        if (gameState.lives <= 0) {
                            gameState.lives = 0;
                            this.endGame(false, "生命值耗尽!");
                        } else {
                            this.flames.splice(i, 1);
                        }
                        this.updateUI();
                    }
                }
                
                // 更新分数弹出效果
                for (let i = this.scorePopups.length - 1; i >= 0; i--) {
                    const popup = this.scorePopups[i];
                    const elapsed = Date.now() - popup.startTime;
                    
                    if (elapsed > 1000) {
                        this.scorePopups.splice(i, 1);
                    }
                }
            },
            
            checkCollision(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            },
            
            renderMenu() {
                ctx.clearRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                gameAssets.drawMenuBg();
                
                // 半透明遮罩
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.fillRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                
                // 标题
                ctx.font = 'bold 60px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#ff7e5f';
                ctx.lineWidth = 4;
                ctx.strokeText('灾害生存指南', GAME_CONFIG.width / 2, 150);
                ctx.fillText('灾害生存指南', GAME_CONFIG.width / 2, 150);
                
                // 副标题
                ctx.font = '36px Arial';
                ctx.fillStyle = '#feb47b';
                ctx.fillText('应急守护者', GAME_CONFIG.width / 2, 210);
                
                // 开始按钮
                const gradient = ctx.createLinearGradient(0, 0, 0, 60);
                gradient.addColorStop(0, '#ff7e5f');
                gradient.addColorStop(1, '#feb47b');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.roundRect(GAME_CONFIG.width / 2 - 125, 320, 250, 60, 30);
                ctx.fill();
                
                ctx.font = 'bold 28px Arial';
                ctx.fillStyle = '#fff';
                ctx.fillText('开始挑战', GAME_CONFIG.width / 2, 360);
                
                // 提示
                ctx.font = '22px Arial';
                ctx.fillStyle = '#ddd';
                ctx.fillText('选择关卡开始游戏，学习灾害应对知识', GAME_CONFIG.width / 2, 480);
                
                // 显示关卡完成状态
                ctx.font = '18px Arial';
                ctx.fillStyle = '#ffcc00';
                ctx.textAlign = 'center';
                
                if (gameState.levelsCompleted.earthquake) {
                    ctx.fillText('地震应急: 已完成 ✓', 200, 500);
                } else {
                    ctx.fillText('地震应急: 未开始', 200, 500);
                }
                
                if (gameState.levelsCompleted.flood) {
                    ctx.fillText('洪水逃生: 已完成 ✓', 400, 500);
                } else {
                    ctx.fillText('洪水逃生: 未开始', 400, 500);
                }
                
                if (gameState.levelsCompleted.fire) {
                    ctx.fillText('火灾逃生: 已完成 ✓', 600, 500);
                } else {
                    ctx.fillText('火灾逃生: 未开始', 600, 500);
                }
            },
            
            renderEarthquakeScene() {
                ctx.clearRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                gameAssets.drawEarthquakeBg();
                
                // 半透明遮罩
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                
                // 标题
                ctx.font = 'bold 42px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#ff7e5f';
                ctx.lineWidth = 3;
                ctx.strokeText('地震应急包准备', GAME_CONFIG.width / 2, 60);
                ctx.fillText('地震应急包准备', GAME_CONFIG.width / 2, 60);
                
                // 提示
                ctx.font = '20px Arial';
                ctx.fillStyle = '#feb47b';
                ctx.fillText('将应急物品拖入应急包，避免拖入非必需品', GAME_CONFIG.width / 2, 105);
                
                // 应急包区域
                ctx.strokeStyle = '#f1c40f';
                ctx.lineWidth = 4;
                ctx.fillStyle = 'rgba(249, 241, 165, 0.7)';
                ctx.beginPath();
                ctx.roundRect(500, 150, 250, 300, 10);
                ctx.fill();
                ctx.stroke();
                
                ctx.font = 'bold 24px Arial';
                ctx.fillStyle = '#f1c40f';
                ctx.textAlign = 'center';
                ctx.fillText('应急包', 625, 140);
                
                // 绘制物品
                this.earthquakeItems.forEach(item => {
                    if (!item.collected) {
                        switch(item.type) {
                            case 'water': gameAssets.drawWater(item.x, item.y); break;
                            case 'food': gameAssets.drawFood(item.x, item.y); break;
                            case 'medicine': gameAssets.drawMedicine(item.x, item.y); break;
                            case 'flashlight': gameAssets.drawFlashlight(item.x, item.y); break;
                            case 'radio': gameAssets.drawRadio(item.x, item.y); break;
                            case 'toy': gameAssets.drawToy(item.x, item.y); break;
                        }
                        
                        // 物品名称
                        ctx.font = '16px Arial';
                        ctx.fillStyle = '#fff';
                        ctx.textAlign = 'center';
                        const textY = item.y + 90;
                        switch(item.type) {
                            case 'water': ctx.fillText('饮用水', item.x + 30, textY); break;
                            case 'food': ctx.fillText('压缩食品', item.x + 30, textY); break;
                            case 'medicine': ctx.fillText('急救包', item.x + 30, textY); break;
                            case 'flashlight': ctx.fillText('手电筒', item.x + 30, textY); break;
                            case 'radio': ctx.fillText('收音机', item.x + 30, textY); break;
                            case 'toy': ctx.fillText('玩具', item.x + 30, textY); break;
                        }
                    }
                });
                
                // 进度信息
                ctx.font = '20px Arial';
                ctx.fillStyle = '#feb47b';
                ctx.textAlign = 'left';
                ctx.fillText(`进度: ${this.correctItemsCount}/${this.totalCorrectItems}`, 20, 550);
            },
            
            renderFloodScene() {
                ctx.clearRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                gameAssets.drawFloodBg();
                
                // 标题
                ctx.font = 'bold 42px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#4776E6';
                ctx.lineWidth = 3;
                ctx.strokeText('洪水逃生', GAME_CONFIG.width / 2, 60);
                ctx.fillText('洪水逃生', GAME_CONFIG.width / 2, 60);
                
                // 提示
                ctx.font = '20px Arial';
                ctx.fillStyle = '#8E54E9';
                ctx.fillText('← → 移动角色收集雨具（300分通关），避开闪电', GAME_CONFIG.width / 2, 105);
                
                // 进度条
                const progressWidth = 500;
                const progress = Math.min(gameState.score / GAME_CONFIG.floodWinScore, 1);
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.roundRect((GAME_CONFIG.width - progressWidth) / 2, 30, progressWidth, 20, 10);
                ctx.fill();
                
                const gradient = ctx.createLinearGradient(0, 0, progressWidth, 0);
                gradient.addColorStop(0, '#ff7e5f');
                gradient.addColorStop(1, '#4776E6');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.roundRect((GAME_CONFIG.width - progressWidth) / 2, 30, progressWidth * progress, 20, 10);
                ctx.fill();
                
                ctx.font = '18px Arial';
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.fillText(`${gameState.score}/${GAME_CONFIG.floodWinScore}`, GAME_CONFIG.width / 2, 48);
                
                // 绘制玩家
                gameAssets.drawPlayer(this.playerX, this.playerY);
                
                // 绘制物品
                this.floodItems.forEach(item => {
                    switch(item.type) {
                        case 'umbrella': gameAssets.drawUmbrella(item.x, item.y); break;
                        case 'lifebuoy': gameAssets.drawLifebuoy(item.x, item.y); break;
                        case 'lightning': gameAssets.drawLightning(item.x, item.y); break;
                    }
                });
                
                // 绘制分数弹出效果
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                const now = Date.now();
                this.scorePopups.forEach(popup => {
                    const elapsed = now - popup.startTime;
                    const progress = elapsed / 1000;
                    const yOffset = progress * 30;
                    
                    ctx.fillStyle = `rgba(255, 204, 0, ${1 - progress})`;
                    ctx.fillText(popup.text, popup.x + 30, popup.y - yOffset);
                });
                
                // 生命值显示
                ctx.font = '20px Arial';
                ctx.fillStyle = '#ff7e5f';
                ctx.textAlign = 'right';
                ctx.fillText(`生命值: ${gameState.lives}`, GAME_CONFIG.width - 20, 30);
                
                // 操作提示
                ctx.font = '16px Arial';
                ctx.fillStyle = '#feb47b';
                ctx.textAlign = 'center';
                ctx.fillText('使用左右方向键移动角色', GAME_CONFIG.width / 2, 550);
            },
            
            renderFireScene() {
                ctx.clearRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                gameAssets.drawFireBg();
                
                // 标题
                ctx.font = 'bold 42px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#FF416C';
                ctx.lineWidth = 3;
                ctx.strokeText('火灾逃生', GAME_CONFIG.width / 2, 60);
                ctx.fillText('火灾逃生', GAME_CONFIG.width / 2, 60);
                
                // 提示
                ctx.font = '20px Arial';
                ctx.fillStyle = '#ffcc00';
                ctx.fillText('方向键移动角色收集防火物品，到达出口', GAME_CONFIG.width / 2, 105);
                
                // 进度条
                const progressWidth = 500;
                const progress = Math.min(gameState.score / GAME_CONFIG.fireWinScore, 1);
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.roundRect((GAME_CONFIG.width - progressWidth) / 2, 30, progressWidth, 20, 10);
                ctx.fill();
                
                const gradient = ctx.createLinearGradient(0, 0, progressWidth, 0);
                gradient.addColorStop(0, '#ff7e5f');
                gradient.addColorStop(1, '#FF416C');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.roundRect((GAME_CONFIG.width - progressWidth) / 2, 30, progressWidth * progress, 20, 10);
                ctx.fill();
                
                ctx.font = '18px Arial';
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.fillText(`${gameState.score}/${GAME_CONFIG.fireWinScore}`, GAME_CONFIG.width / 2, 48);
                
                // 绘制出口
                gameAssets.drawExitSign(this.exit.x, this.exit.y);
                
                // 绘制玩家
                gameAssets.drawPlayer(this.playerX, this.playerY);
                
                // 绘制物品
                this.fireItems.forEach(item => {
                    switch(item.type) {
                        case 'towel': gameAssets.drawTowel(item.x, item.y); break;
                        case 'fireBlanket': gameAssets.drawFireBlanket(item.x, item.y); break;
                        case 'exit': gameAssets.drawExitSign(item.x, item.y); break;
                    }
                });
                
                // 绘制火焰
                this.flames.forEach(flame => {
                    gameAssets.drawFlame(flame.x, flame.y);
                });
                
                // 绘制分数弹出效果
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                const now = Date.now();
                this.scorePopups.forEach(popup => {
                    const elapsed = now - popup.startTime;
                    const progress = elapsed / 1000;
                    const yOffset = progress * 30;
                    
                    ctx.fillStyle = `rgba(255, 204, 0, ${1 - progress})`;
                    ctx.fillText(popup.text, popup.x + 30, popup.y - yOffset);
                });
                
                // 生命值显示
                ctx.font = '20px Arial';
                ctx.fillStyle = '#ff7e5f';
                ctx.textAlign = 'right';
                ctx.fillText(`生命值: ${gameState.lives}`, GAME_CONFIG.width - 20, 30);
                
                // 操作提示
                ctx.font = '16px Arial';
                ctx.fillStyle = '#ffcc00';
                ctx.textAlign = 'center';
                ctx.fillText('使用方向键移动角色', GAME_CONFIG.width / 2, 550);
            },
            
            gameLoop(timestamp) {
                // 清除画布
                ctx.clearRect(0, 0, GAME_CONFIG.width, GAME_CONFIG.height);
                
                // 根据当前状态渲染不同场景
                switch(gameState.currentLevel) {
                    case 'menu':
                        this.renderMenu();
                        break;
                    case 'earthquake':
                        this.renderEarthquakeScene();
                        break;
                    case 'flood':
                        if (gameState.gameRunning) {
                            this.generateFloodItems();
                            this.updateFloodItems();
                        }
                        this.renderFloodScene();
                        break;
                    case 'fire':
                        if (gameState.gameRunning) {
                            this.generateFireItems();
                            this.updateFireScene();
                        }
                        this.renderFireScene();
                        break;
                }
                
                // 继续动画循环
                requestAnimationFrame((ts) => this.gameLoop(ts));
            }
        };

        // 添加Canvas roundRect方法
        CanvasRenderingContext2D.prototype.roundRect = function (x, y, width, height, radius) {
            if (width < 2 * radius) radius = width / 2;
            if (height < 2 * radius) radius = height / 2;
            this.beginPath();
            this.moveTo(x + radius, y);
            this.arcTo(x + width, y, x + width, y + height, radius);
            this.arcTo(x + width, y + height, x, y + height, radius);
            this.arcTo(x, y + height, x, y, radius);
            this.arcTo(x, y, x + width, y, radius);
            this.closePath();
            return this;
        };

        // 初始化游戏
        game.init();
    </script>
</body>
</html>